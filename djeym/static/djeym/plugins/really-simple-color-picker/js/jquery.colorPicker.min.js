(function($){let selectorOwner;let activePalette;let cItterate=0;let templates={control:$("<div class=\"colorPicker-picker\">&nbsp;</div>"),palette:$("<div id=\"colorPicker_palette\" class=\"colorPicker-palette\" />"),swatch:$("<div class=\"colorPicker-swatch\">&nbsp;</div>"),hexLabel:$("<label for=\"colorPicker_hex\">Hex: </label>"),hexField:$("<input type=\"text\" id=\"colorPicker_hex\" />")};let transparent="transparent";let lastColor;$.fn.colorPicker=function(options){return this.each(function(){let element=$(this);let opts=$.extend({},$.fn.colorPicker.defaults,options);let defaultColor=$.fn.colorPicker.toHex((element.val().length>0)?element.val():opts.pickerDefault);let newControl=templates.control.clone();let newPalette=templates.palette.clone().attr("id","colorPicker_palette-"+cItterate);let newHexLabel=templates.hexLabel.clone();let newHexField=templates.hexField.clone();let paletteId=newPalette[0].id;let swatch;let controlText;$.each(opts.colors,function(i){swatch=templates.swatch.clone();if(opts.colors[i]===transparent){swatch.addClass(transparent).text("X");$.fn.colorPicker.bindPalette(newHexField,swatch,transparent);}else{swatch.css("background-color","#"+this);$.fn.colorPicker.bindPalette(newHexField,swatch);};swatch.appendTo(newPalette);});newHexLabel.attr("for","colorPicker_hex-"+cItterate);newHexField.attr({id:"colorPicker_hex-"+cItterate,value:defaultColor});newHexField.bind("keydown",function(event){if(event.keyCode===13){let hexColor=$.fn.colorPicker.toHex($(this).val());$.fn.colorPicker.changeColor(hexColor||element.val());};if(event.keyCode===27){$.fn.colorPicker.hidePalette();}});newHexField.on("keyup",function(event){let hexColor=$.fn.colorPicker.toHex($(event.target).val());$.fn.colorPicker.previewColor(hexColor||element.val());});$("<div class=\"colorPicker_hexWrap\" />").append(newHexLabel).appendTo(newPalette);newPalette.find(".colorPicker_hexWrap").append(newHexField);if(opts.showHexField===false){newHexField.hide();newHexLabel.hide();};$("body").append(newPalette);newPalette.hide();newControl.css("background-color",defaultColor);newControl.on("click",function(event){event.preventDefault?event.preventDefault():(event.returnValue=false);if(element.is(":not(:disabled)")){$.fn.colorPicker.togglePalette($("#"+paletteId),$(this));}});if(options&&options.onColorChange){newControl.data("onColorChange",options.onColorChange);}else{newControl.data("onColorChange",function(){});};controlText=element.data("text");if(controlText){newControl.html(controlText);};element.after(newControl);element.on("change",function(){element.next(".colorPicker-picker").css("background-color",$.fn.colorPicker.toHex($(this).val()));});element.val(defaultColor);if(element[0].tagName.toLowerCase()==="input"){try{element.attr("type","hidden");}catch(err){element.css("visibility","hidden").css("position","absolute");}}else{element.hide();};cItterate++;});};$.extend(true,$.fn.colorPicker,{toHex:function(color){if(color.match(/[0-9A-F]{6}|[0-9A-F]{3}$/i)){return(color.charAt(0)==="#")?color:("#"+color);}else if(color.match(/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/)){let c=([parseInt(RegExp.$1,10),parseInt(RegExp.$2,10),parseInt(RegExp.$3,10)]);let pad=function(str){if(str.length<2){for(let i=0,len=2-str.length;i<len;i++){str="0"+str;}};return str;};if(c.length===3){let r=pad(c[0].toString(16));let g=pad(c[1].toString(16));let b=pad(c[2].toString(16));return"#"+r+g+b;}}else{return false;}},checkMouse:function(event,paletteId){let selector=activePalette;let selectorParent=$(event.target).parents("#"+selector.attr("id")).length;if(event.target===$(selector)[0]||event.target===selectorOwner[0]||selectorParent>0){return;};$.fn.colorPicker.hidePalette();},hidePalette:function(){$(document).off("mousedown",$.fn.colorPicker.checkMouse);$(".colorPicker-palette").hide();},showPalette:function(palette){let hexColor=selectorOwner.prev("input").val();palette.css({top:selectorOwner.offset().top+(selectorOwner.outerHeight()),left:selectorOwner.offset().left});$("#color_value").val(hexColor);palette.show();$(document).on("mousedown",$.fn.colorPicker.checkMouse);},togglePalette:function(palette,origin){if(origin){selectorOwner=origin;};activePalette=palette;if(activePalette.is(":visible")){$.fn.colorPicker.hidePalette();}else{$.fn.colorPicker.showPalette(palette);}},changeColor:function(value){selectorOwner.css("background-color",value);selectorOwner.prev("input").val(value).change();$.fn.colorPicker.hidePalette();selectorOwner.data("onColorChange").call(selectorOwner,$(selectorOwner).prev("input").attr("id"),value);},previewColor:function(value){selectorOwner.css("background-color",value);},bindPalette:function(paletteInput,element,color){color=color||$.fn.colorPicker.toHex(element.css("background-color"));element.on("click",function(event){event.preventDefault?event.preventDefault():(event.returnValue=false);lastColor=color;$.fn.colorPicker.changeColor(color);}).on("mouseover",function(){lastColor=paletteInput.val();paletteInput.val(color);$.fn.colorPicker.previewColor(color);}).on("mouseout",function(){paletteInput.val(selectorOwner.css("background-color"));paletteInput.val(lastColor);$.fn.colorPicker.previewColor(lastColor);});}});$.fn.colorPicker.defaults={pickerDefault:"ffffff",colors:["#1abc9c","#16a085","#2ecc71","#27ae60","#3498db","#2980b9","#9b59b6","#8e44ad","#34495e","#2c3e50","#f1c40f","#f39c12","#e67e22","#d35400","#e74c3c","#c0392b","#ecf0f1","#bdc3c7","#95a5a6","#7f8c8d"],addColors:[],showHexField:true};})(jQuery);