var runCKEditorResizeImage;$(document).ready(function(){"use strict";try{CKEDITOR.on("dialogDefinition",function(event){let dialogName=event.data.name;let dialogDefinition=event.data.definition;if(dialogName==="image"){let onOk=dialogDefinition.onOk;dialogDefinition.onOk=function(event){let width=this.getContentElement("info","txtWidth");let height=this.getContentElement("info","txtHeight");let tmpWidth=+width.getValue();if(tmpWidth>322){height.setValue(Math.floor(+height.getValue()*(322/tmpWidth)));width.setValue("322");};onOk&&onOk.apply(this,event);};}});runCKEditorResizeImage=function(){$(document).on("click","a.cke_dialog_tab_selected",function(event){let $this=$(this);let commonParent=$this.parent().parent();let buttonLoadOnServer=commonParent.find("a.cke_dialog_ui_fileButton");let parentOfButton=buttonLoadOnServer.parent();let iframeContents=commonParent.find("td.cke_dialog_ui_vbox_child iframe").contents();let formOfUpload=iframeContents.find("form");let controlAgent=parentOfButton.find("div.cke_control_agent");if(controlAgent.length!==0){commonParent.find("tr.cke_info_upload_image").remove();controlAgent.off("click");controlAgent.remove();};parentOfButton.css("position","relative");parentOfButton.parent().before("<tr class='cke_info_upload_image'><td>"+"<img src='/static/djeym/img/loader.gif' class='cke_image_upload_indicator' "+"style='display: none; margin: 20px 0;' alt='upload indicator'><div>"+;gettext("Image size will be optimized to 966 pixels.")+"</div></td></tr>");commonParent.find("tr.cke_info_upload_image td div").css({margin:"20px 0 10px",color:"#0782c1","font-size":"14px","font-weight":"bold"});parentOfButton.prepend("<div class='cke_control_agent'></div>");controlAgent=parentOfButton.find("div.cke_control_agent");controlAgent.css({position:"absolute",top:"0",right:"0",bottom:"0",left:"0","z-index":"1",cursor:"pointer"});controlAgent.on("click",function(event){if(!(window.File&&window.FileReader&&window.FileList&&window.Blob)){alert(gettext("The File APIs are not fully supported in this browser. "+"Upgrade your browser - http:;            return;;          };;          let fileUpload = formOfUpload.find( "input[name=\"upload\"]")[0].files[0];creatingThumbnails(fileUpload,formOfUpload);});});function creatingThumbnails(fileUpload,formOfUpload){if(fileUpload!==undefined){let fileType=fileUpload.type;if(fileType!=="image/jpeg"&&fileType!=="image/png"){formOfUpload.trigger("reset");alert(gettext("Only JPG and PNG files."));return;};const MAX_WIDTH=966;const MAX_HEIGHT=966;let reader=new FileReader();let tempImg=new Image();let tempW;let tempH;let uploadIndicator=$("img.cke_image_upload_indicator");uploadIndicator.css("display","block");reader.onload=function(event){tempImg.onload=function(){tempW=tempImg.width;tempH=tempImg.height;if(tempW>tempH){if(tempW>MAX_WIDTH){tempH=Math.floor(tempH*(MAX_WIDTH/tempW));tempW=MAX_WIDTH;}}else{if(tempH>MAX_HEIGHT){tempW=Math.floor((tempW*MAX_HEIGHT/tempH));tempH=MAX_HEIGHT;}};let canvas=document.getElementById("cke_temp_canvas");let ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);canvas.width=tempW;canvas.height=tempH;ctx.drawImage(tempImg,0,0,tempW,tempH);let dataURI=canvas.toDataURL(fileType);let imageBlob=(function(){let binary=atob(dataURI.split(",")[1]);let array=[];for(let idx=0;idx<binary.length;idx++){array.push(binary.charCodeAt(idx));};return new Blob([new Uint8Array(array)],{type:fileType});})();let tempFormData=new FormData();tempFormData.append("upload",imageBlob,fileUpload.name);$.ajax({type:"POST",url:formOfUpload.attr("action"),data:tempFormData,processData:false,contentType:false}).done(function(response){}).fail(function(){alert(gettext("Server Error ???"));}).always(function(){uploadIndicator.css("display","none");formOfUpload.trigger("reset");});};tempImg.src=event.target.result;};reader.readAsDataURL(fileUpload);}}};if(!$("form").is("#id_form_geoobjects")){runCKEditorResizeImage();}}catch(err){}});